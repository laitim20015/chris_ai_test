###階段一：問題識別與根因分析
[x] 1.1 當前關聯結果問題
多數關聯在「圖片信息」區塊顯示 Caption檢測: ✅，但「關聯類型」仍是 spatial，呈現自相矛盾。
相同圖片被重複關聯到多個後續步驟段落，未優先關聯到應該解釋該圖的上方說明段落（例如段落102）。
[x] 1.2 權重配置狀態
主流程加權符合規範（Caption 0.4, Spatial 0.3, Semantic 0.15, Layout 0.1, Proximity 0.05），加權本身不是主要問題。
[x] 1.3 空間距離計算缺陷（關鍵）
在產線流程中，增強空間分析的「動態佈局檢測」被硬塞成單欄，導致真實佈局偵測被抑制，破壞了動態歸一化與跨欄懲罰等判斷：
            context_info = {
                'all_elements': all_elements,
                'layout_type': 'single_column',  # 默認設置，後續可擴展為動態檢測
                'text_content': text_block.content  # 傳遞文本內容以供分析
            }
而增強空間評分實作中只有在沒有 layout_type 時才會啟用檢測：
        if context_info and 'all_elements' in context_info:
            # 檢測文檔佈局
            column_info = detect_layout_columns(context_info['all_elements'])
            # 分析跨欄位關係
            cross_column_analysis = analyze_cross_column_relationship(text_bbox, image_bbox, column_info)

    # 更新上下文信息中的佈局類型
            if 'layout_type' not in context_info:
                context_info['layout_type'] = column_info['layout_type']


###階段二：具體問題驗證
[x] 2.1 段落102問題仍在
段落102「下列圖表描述了工作對商務名片進行拼版的方式。」上方說明未被優先關聯至緊接的圖，圖片卻多次關聯到較遠的步驟段落。
輸出中同一張圖多次出現於較後段落，示例：`<div class="image-association">`
    ![Image](http://localhost:8000/images/2025/08/11/workflows_sample_p011_img001_aa542fa9.png)
    **圖片信息:**
    - 🎯 關聯度: 0.479
    - 📍 關聯類型: spatial
    - 🔍 Caption檢測: ✅
    `</div>`
[x] 2.2 為何全部顯示 spatial？
關聯類型在主流程一次性決定："caption" if caption_score > 0.5 else "spatial"，且此欄位在後續優化階段不會被更新：
            "spatial_relation": "enhanced",
            "association_type": "caption" if caption_score > 0.5 else "spatial",
優化器只做加成/過濾，不會改寫 association_type；因此即使後續根據 Caption 提升了關聯分數，輸出仍保留舊的 "spatial" 標籤，造成「顯示 ✅ 但類型為 spatial」的不一致。
[x] 2.3 Caption 檢測狀態
Caption 檢測模式涵蓋「描述/圖表」等詞，段落102具備觸發條件；但主流程每對「單一文本-單一圖片」局部檢測，未使用已實作的「最近上方優先」跨候選策略，導致未將圖關聯到最合理的上方段落。
已有的強化檢測（最近上方優先）在 CandidateRanker 中，但主流程未採用該排序器進行每圖的候選選擇。
根因結論
動態佈局/距離邏輯被硬性禁用，削弱了空間分數的判別力（特別是多欄/跨欄的懲罰與自適應歸一化）。這與我們先前的關鍵教訓一致：改動應落在產線邏輯中使歸一化正確生效 1。
association_type 的決策時點過早，且未隨優化後的 Caption 信號同步更新，導致「Caption檢測: ✅ 但類型仍為 spatial」。
主流程未整合 CandidateRanker 的「最近上方優先」規則，無法對「同一張圖的多個文本候選」進行全局最優選擇，特別影響段落102這類「圖前導說明」的關聯。

###階段三：建議改進（小而準的修正）
[提案A] 解除動態佈局檢測的封印
-在 src/main.py::_perform_association_analysis 建立 context_info 時，移除固定的 'layout_type': 'single_column'，讓增強空間分析自動檢測佈局並應用跨欄懲罰/動態歸一化。
[提案B] 同步更新 association_type
-在優化器 AssociationOptimizer._apply_caption_boost 中，若 caption_score >= caption_min_confidence 或 caption_boosted 為 True，將 assoc["association_type"] = "caption"，確保輸出一致。
[提案C] 對每張圖採用候選排序器（逐步導入）
-用 CandidateRanker.rank_candidates 對每張圖片的文本候選做排序，優先選擇「最近上方且具 Caption 指示詞」的文本。先以「每圖Top-1」寫回，再保留少量高分補充（可控上限）。
是否同意我直接執行這三項小修正（不新增檔案，只編輯既有邏輯）？同意後我會：
-調整 src/main.py 的 context_info（啟用動態佈局檢測）。
-在 AssociationOptimizer 內同步 association_type（避免 type 與 Caption 顯示不一致）。
-增量整合 CandidateRanker 於主流程（先做每圖 Top-1 排序選擇，最小侵入實作）。

###簡短總結
問題重點：佈局檢測被關閉、關聯類型未隨優化更新、未用最近上方優先的候選排序。
影響結果：圖片常被關聯到較遠段落；顯示 Caption ✅ 但類型仍標 spatial。
修正建議：啟用動態佈局、同步更新 association_type、採用 CandidateRanker 的最近上方優先規則。





## 當前問題重新分析

基於最新的workflows_sample_complete.md，問題依然存在：

1. 佈局檢測被禁用 - layout_type: 'single_column' 仍然硬編碼
2. 關聯策略原始 - 仍使用逐一配對而非智能候選排序
3. 關聯類型不一致 - Caption檢測✅但類型顯示spatial




## 🎯 關鍵改進點

### 1. 智能候選選擇

* 從「逐一文本配對」改為「每圖智能排序」
* 優先選擇最近上方且具Caption指示詞的文本
* 解決段落102類問題（圖片被關聯到遠距離段落）

### 2. 動態佈局感知

* 移除硬編碼的single_column限制
* 啟用跨欄懲罰和動態距離歸一化
* 提升空間關係判斷準確性

### 3. 類型一致性

* Caption加成時同步更新association_type
* 確保「Caption檢測✅」與「關聯類型: caption」一致

## 📊 預期效果

執行這些修正後，應該看到：

1. 段落102正確關聯 - "下列圖表描述了工作對商務名片進行拼版的方式" 將優先關聯到其下方圖片
2. 減少重複關聯 - 同一圖片不會過度關聯到多個遠距離段落
3. 類型顯示一致 - 有Caption指示的關聯將正確顯示為"caption"類型
4. 空間判斷精準 - 動態佈局檢測將提升距離計算的準確性

這個完整方案直接解決了根因問題，整合了已開發的Caption優先策略，符合項目規則和之前的關鍵教訓 **1**。
