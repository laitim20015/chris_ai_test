# 圖文關聯錯位問題分析與解決方案

## 📋 問題概述

在智能文檔轉換系統的測試中發現了兩個關鍵問題：

1. **圖文關聯錯位**：段落102（"下列圖表描述了工作對商務名片進行拼版的方式"）明確指向其下方的圖片，但系統卻將該圖片關聯到了段落116和120
2. **圖片路徑問題**：Markdown中使用相對路徑`./images/...`而非存儲後的完整URL

## 🔍 問題詳細分析

### 實際PDF佈局情況

```
段落102: 下列圖表描述了工作對商務名片進行拼版的方式。
[圖片位置]
段落103: 1 5 欄
段落104: 2 5 列
段落105: 3 2 x 3.25 商務名片
段落106: 4 11 x 17 頁面
段落107: 工作流程範例
段落108: 拼版工作流程
段落109: 9
段落110: 使用拼版列印範例卡片
段落111: 您可在 Command WorkStation 中開啟檔案，選擇 聯合拼版和重複...
段落112: 此範例使用下列項目：
段落113: • 定義 2 x 3.25 商務名片的 PDF 檔案
段落114: • Fiery Server
段落115: • Command WorkStation 與 Fiery Impose (需要授權)
段落116: • 11 x 17 重磅紙，如卡片紙張  ← 圖片錯誤關聯到這裡
段落117: 1 將 PDF 檔案匯入 Command WorkStation。
段落118: 2 選取工作。
段落119: 3 按一下動作 > Impose。
段落120: 4 選擇聯合拼版，然後選擇重複。    ← 圖片錯誤關聯到這裡
```

### 根本原因分析

經過深入分析代碼發現，問題的根源在於**空間距離計算的歸一化參數**：

#### 1. 固定歸一化參數的問題

```python
# 現有代碼 (complete_end_to_end_test.py, 約310-313行)
spatial_score = 1.0 - min(spatial_features.center_distance / 1000.0, 1.0)
proximity_score = min(1.0, 1.0 - min(spatial_features.min_distance / 500.0, 1.0))
```

**問題所在**：
- 使用**固定的1000像素和500像素**作為歸一化基準
- PDF頁面尺寸通常很大（A4是595×842點），段落間距可能輕易超過這些閾值
- 導致段落102到其下方圖片的距離被判定為"太遠"

#### 2. 權重分配的影響

根據項目規格，評分權重分配為：
- Caption: 40%
- Spatial: 30% 
- Semantic: 15%
- Layout: 10%
- Proximity: 5%

即使段落102沒有明確的caption匹配，空間分數（30%）+ 距離分數（5%）= 35%的權重足以讓物理上更近的段落勝出。

#### 3. 實際距離對比

```
段落102 → 圖片：可能距離 > 500像素（被判定為"遠"）
段落116 → 圖片：可能距離 < 100像素（被判定為"近"）
段落120 → 圖片：可能距離 < 150像素（被判定為"近"）
```

### 測試報告數據證實

從 `data/output/test_report.md` 的樣本關聯數據可以看到：

```
關聯 1: 分數0.835, Caption分數0.792, 空間分數0.999
關聯 2: 分數0.802, Caption分數0.792, 空間分數0.999  
關聯 3: 分數0.801, Caption分數0.792, 空間分數1.000
```

高空間分數（0.999-1.000）表明這些關聯的段落與圖片物理距離非常近，證實了我們的分析。

## 🛠️ 解決方案

### 核心策略：動態空間距離歸一化

採用**基於頁面尺寸的動態歸一化**，使空間距離計算能夠適應不同大小的文檔。

### 具體修改方案

#### 修改1：動態距離歸一化 (`complete_end_to_end_test.py`)

**位置**：約310-313行

**原始代碼**：
```python
spatial_score = 1.0 - min(spatial_features.center_distance / 1000.0, 1.0) if spatial_features else 0.0
layout_score = spatial_features.alignment_score if spatial_features else 0.0
proximity_score = min(1.0, 1.0 - min(spatial_features.min_distance / 500.0, 1.0)) if spatial_features else 0.0
```

**修改為**：
```python
if spatial_features:
    # 估算頁面尺寸（使用所有元素的最大座標）
    page_width = max(text_block.bbox.right, image.bbox.right)
    page_height = max(text_block.bbox.bottom, image.bbox.bottom)
    page_diagonal = (page_width ** 2 + page_height ** 2) ** 0.5
    
    # 使用頁面對角線的比例作為歸一化基準
    # 對角線的30%作為"近距離"，50%作為"中距離"
    spatial_score = 1.0 - min(spatial_features.center_distance / (page_diagonal * 0.5), 1.0)
    proximity_score = 1.0 - min(spatial_features.min_distance / (page_diagonal * 0.3), 1.0)
    layout_score = spatial_features.alignment_score
else:
    spatial_score = 0.0
    proximity_score = 0.0
    layout_score = 0.0
```

#### 修改2：圖片URL路徑 (`src/markdown/templates/enhanced.md.j2`)

**位置**：第33行

**原始代碼**：
```jinja2
![{{ image_data.image.alt_text or 'Image' }}](./images/{{ image_data.image.filename or (image_data.image.id + '.png') }})
```

**修改為**：
```jinja2
![{{ image_data.image.alt_text or 'Image' }}]({{ image_data.image.url or ('./images/' ~ (image_data.image.filename or (image_data.image.id ~ '.png'))) }})
```

### 方案優勢

1. **最小改動**：只修改距離計算邏輯，不影響整體架構
2. **自適應**：根據實際頁面大小動態調整，適用於各種文檔
3. **保持簡單**：不增加新的評分維度或複雜規則
4. **效果立竿見影**：段落102與其下方圖片的距離將被正確評估
5. **符合原則**：遵循"最貼近的圖跟字段做關聯"的核心原則

## 📊 預期效果

### 關聯修正
- ✅ 段落102（"下列圖表描述了..."）將正確關聯到其下方的圖片
- ✅ 空間距離評分將根據頁面實際大小進行合理計算
- ✅ 減少錯誤關聯到遠距離段落的情況

### URL路徑修正
- ✅ 圖片URL將顯示為完整路徑（如：`http://localhost:8000/images/2025/08/09/workflows_sample_p011_img001_aa542fa9.png`）
- ✅ 支援RAG檢索時正確返回圖文關聯結果
- ✅ 便於前端系統直接載入圖片資源

## 🧪 測試驗證步驟

### 1. 執行修改

按照上述方案修改相應文件

### 2. 運行測試

```bash
python complete_end_to_end_test.py
```

### 3. 驗證結果

檢查以下項目：

1. **關聯正確性**：
   - 檢查 `data/output/workflows_sample_complete.md`
   - 確認段落102下方顯示其對應的圖片
   - 確認段落116、120不再錯誤顯示該圖片

2. **URL路徑**：
   - 確認圖片路徑為完整URL而非相對路徑
   - 測試URL可訪問性

3. **性能指標**：
   - 檢查 `data/output/test_report.md`
   - 關聯數量和質量是否保持穩定

## 🔚 總結

這個解決方案直接針對問題的根本原因：

- **問題核心**：固定的距離歸一化參數導致空間關係計算不準確
- **解決策略**：採用基於頁面尺寸的動態歸一化
- **實施原則**：最小改動、保持簡潔、效果明顯

通過這個修改，系統將能夠：
1. 正確識別段落與其邏輯相關圖片的關聯
2. 提供完整的圖片URL支援RAG檢索功能
3. 維持整體系統的穩定性和性能

---

**文檔創建時間**：2025-08-10  
**問題類型**：圖文關聯算法優化  
**修改範圍**：空間距離計算、Markdown模板  
**預期影響**：提升關聯準確性、支援RAG檢索
